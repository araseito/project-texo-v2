name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Configure npm for GitHub Packages
      run: |
        echo "registry=https://registry.npmjs.org/" > ~/.npmrc
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PAT }}" >> ~/.npmrc

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Deploy to GitHub Pages
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        touch public/.nojekyll
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git add public
        git commit -m 'deploy' || echo "No changes to commit"
        git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} `git subtree split --prefix public main`:refs/heads/gh-pages --force
